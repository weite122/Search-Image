<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SearchImage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        header {
            padding: 40px 0;
            text-align: center;
        }
        
        header input {
            width: 220px;
            padding: 5px;
            outline: none;
        }
        
        main {
            padding: 10px;
        }
        
        main::after {
            display: block;
            content: '';
            clear: both;
        }
        
        main>figure {
            float: left;
            padding: 5px;
            transition: all .5s;
        }
        
        main>figure img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <header>
        <input id="serachInput" placeholder="Enter picture name" type="text">
    </header>
    <main>
        <!-- <figure>
            <img src="https://cdn.pixabay.com/photo/2015/03/12/17/57/buddha-670573_150.jpg" alt="">
        </figure> -->
    </main>

    <script>


        let mainNode = document.querySelector('main')
        var searchInput = document.querySelector('#serachInput')
        let mainNodeWidth = parseFloat(mainNode.clientWidth)-35
        let baseHeight = 200
        let rowList = []
        let rowTotalWidth = 0
        
        
        searchInput.oninput = throttle(function() {
            start()
        }, 200)

        window.onresize = throttle(function() {
            start()
        }, 200)

        function start() {
            mainNodeWidth = parseFloat(mainNode.clientWidth)-20
            mainNode.innerHTML = ''
            rowList = []
            rowTotalWidth = 0
            loadData(searchInput.value)
                .then(render)
        }

        loadData('beijing')
            .then(render)
            .catch(function(err){
                console.log(err)
            })

        function throttle(fn, delay) {
            var timer = null
            return function() {
                var context = this
                clearTimeout(timer)
                timer = setTimeout(function() {
                    fn.apply(context, arguments);
                }, delay)
            }
        }

        function render(data) {
            // console.log(data.hits)
            total = data.total

            data.hits.forEach(function(imgInformation) {
                imgInformation.ratio = imgInformation.webformatWidth / imgInformation.webformatHeight
                imgInformation.newWidth = imgInformation.ratio * baseHeight

                if (rowTotalWidth + imgInformation.newWidth <= mainNodeWidth) {
                    rowList.push(imgInformation)
                    rowTotalWidth += imgInformation.newWidth
                } else {
                    rowHeight = (mainNodeWidth / rowTotalWidth) * baseHeight
                    layout(rowList, rowHeight)
                    rowList = [imgInformation]
                    rowTotalWidth = imgInformation.newWidth
                }

            })
            layout(rowList, baseHeight)

        }

        function layout(row, rowHeight) {
            row.forEach(function(imgInformation) {
                let figureNode = document.createElement('figure')
                let imgNode = document.createElement('img')
                imgNode.src = imgInformation.webformatURL
                figureNode.appendChild(imgNode)
                console.log(mainNodeWidth,rowTotalWidth)
                console.log('-------')
                figureNode.style.height = rowHeight + 'px'
                figureNode.style.width = rowHeight * imgInformation.ratio + 'px'
                mainNode.appendChild(figureNode)
            })

        }



        function loadData(keyword){
            let url = '//pixabay.com/api/'
            let data = {
                key: '5856858-0ecb4651f10bff79efd6c1044',
                q: keyword,
                image_type: 'photo',
                per_page:20
            }
            return new Promise((resolve,reject)=>{
                let xhr = new XMLHttpRequest()
                // console.log(makeFullUrl(url,data))
                xhr.open('GET',makeFullUrl(url,data),true)
                xhr.send()
                xhr.onload = function(){
                    resolve(JSON.parse(this.response))
                }
                xhr.onerror = function(){
                    reject(this.statusText)
                }
            })
        }

        function makeFullUrl(url,json){
            let arr = []
            for(let key in json) {
                arr.push(encodeURIComponent(key) + '=' + encodeURIComponent(json[key]))
            }
            return url + '?' + arr.join('&')
        }

        function isToBottom(){
          return document.body.scrollHeight- document.body.scrollTop - document.documentElement.clientHeight < 5
        }

    </script>
</body>
</html>  